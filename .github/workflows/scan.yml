name:  Platform Scan Repo


on:
  push:
#  workflow_dispatch:
#    inputs:
#      docker_push:
#        description: 'Push the docker image to dockerhub and outout reference'
#        required: false
#        default: 'false'


#  workflow_call:
#    inputs:

jobs:
  scan_repo:
    name: Scan Repo
    env:
      SEVERITY: 'CRITICAL,HIGH'
      REPORT: 'repo-results.sarif'
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Trivy vulnerability scanner (Repo)
      if: env.SEVERITY != ''
      uses: aquasecurity/trivy-action@master
      with:
        format: 'sarif'
        output:  ${{ env.REPORT }}
        scan-type: 'fs'
        exit-code: '1'
        ignore-unfixed: true
        #severity: ${{ env.SEVERITY }}
        security-checks: 'vuln,config,secret'

    - name: Upload Trivy scan results to GitHub Security tab
      if: always()
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file:  ${{ env.REPORT }}

    - name: Store CVE report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: ${{ env.REPORT }}
        path: ${{ env.REPORT }}
        retention-days: 3

  scan_worker:
    name: Scan worker
    env:
      SEVERITY: 'CRITICAL,HIGH'
      REPORT: 'worker-results.sarif'
      REQU_FILE: 'requirements-worker.txt'
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Switch requirments file
      run: |
        rm requirements.txt
        cp ${{ env.REQU_FILE }} requirements.txt

    - name: Vulnerability scanner
      if: env.SEVERITY != ''
      uses: aquasecurity/trivy-action@master
      with:
        format: 'sarif'
        output: ${{ env.REPORT }}
        scan-type: 'fs'
        exit-code: '1'
        ignore-unfixed: true
        #severity: ${{ env.SEVERITY }}
        security-checks: 'vuln,config,secret'

    - name: Rename requirments file in report
      if: always()
      run: sed -i "s|requirements.txt|${{ env.REPORT }}|g" results.sarif

    - name: Upload Trivy scan results to GitHub Security tab
      if: always()
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: ${{ env.REPORT }}

    - name: Store report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: ${{ env.REPORT }}
        path: ${{ env.REPORT }}
        retention-days: 3

  scan_server:
    name: Scan Server
    env:
      SEVERITY: 'CRITICAL,HIGH'
      REPORT: 'server-results.sarif'
      REQU_FILE: 'requirements-server.txt'
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Switch requirments file
      run: |
        rm requirements.txt
        cp ${{ env.REQU_FILE }} requirements.txt

    - name: Vulnerability scanner
      if: env.SEVERITY != ''
      uses: aquasecurity/trivy-action@master
      with:
        format: 'sarif'
        output: ${{ env.REPORT }}
        scan-type: 'fs'
        exit-code: '1'
        ignore-unfixed: true
        #severity: ${{ env.SEVERITY }}
        security-checks: 'vuln,config,secret'

    - name: Rename requirments file in report
      if: always()
      run: sed -i "s|requirements.txt|${{ env.REPORT }}|g" results.sarif

    - name: Upload Trivy scan results to GitHub Security tab
      if: always()
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: ${{ env.REPORT }}

    - name: Store report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: ${{ env.REPORT }}
        path: ${{ env.REPORT }}
        retention-days: 3

#    - name: Attach link to job summary

# https://github.com/OasisLMF/OasisPlatform/security/code-scanning?query=branch%3A{ -- branch name --}
